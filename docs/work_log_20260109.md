# Work Log: 2026-01-09

## Phase 2C Implementation

### What Changed

1. **New file: `story_registry.py`**
   - SQLite persistent storage for story registry
   - Schema versioning via `meta` table
   - Tables: `stories`, `story_similarity_edges`
   - Configurable DB path via `STORY_REGISTRY_DB_PATH` env var

2. **Modified: `horror_story_generator.py`**
   - Added `exclude_template_ids` parameter to `select_random_template()` (line 218-261)
   - Added Phase 2C control functions:
     - `load_past_stories_into_memory()` (line 460-490)
     - `get_similarity_signal()` (line 493-505)
     - `should_accept_story()` (line 508-521)
   - Added `generate_with_dedup_control()` (line 1198-1389)

3. **Modified: `main.py`**
   - Added imports for story_registry and new control functions
   - Added CLI arguments: `--enable-dedup`, `--db-path`, `--load-history`, `--run-research-stub`
   - Added `run_research_stub()` function (line 273-300)
   - Modified `main()` to:
     - Initialize registry on start when dedup enabled
     - Load past stories into memory
     - Use controlled generation in loop
     - Track skip statistics
     - Close registry on exit

4. **New docs:**
   - `docs/PHASE2C_DEDUP_CONTROL.md`
   - `docs/PHASE2C_RESEARCH_JOB.md`

### Why

Phase 2B provided observation-only similarity detection. Phase 2C adds:
- Persistent memory across restarts (SQLite)
- HIGH-only control (regenerate up to 2 times on HIGH, then skip)
- Forced template change on final attempt

This prevents semantic duplication while allowing LOW/MEDIUM stories through.

### Diff Summary

| File | Lines Added | Lines Removed |
|------|-------------|---------------|
| story_registry.py | ~280 (new) | 0 |
| horror_story_generator.py | ~250 | ~5 |
| main.py | ~80 | ~20 |

### How to Test

```bash
# Basic test (single story, no dedup)
python main.py

# Enable dedup control
python main.py --enable-dedup --max-stories 3

# Check registry
sqlite3 ./data/story_registry.db "SELECT id, accepted, decision_reason FROM stories"

# Test research stub
python main.py --run-research-stub
cat ./data/research_cards.jsonl

# Check logs for Phase 2C
python main.py --enable-dedup 2>&1 | grep -E "\[Phase2C\]"
```

### Verification Checklist

- [x] MEDIUM is NOT blocked (only HIGH)
- [x] No external dependencies added (stdlib only)
- [x] Memory resets on restart (persistent via SQLite, in-memory rebuilt on start)
- [x] No infinite loop (max 3 attempts then skip)
- [x] Forced template change on Attempt 2 only
- [x] Phase 2B logs preserved (`[Phase2B][OBSERVE]`)
- [x] Phase 2C logs added (`[Phase2C][CONTROL]`)
