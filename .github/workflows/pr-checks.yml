name: PR Validation

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  # PR 제목이 Conventional Commits 형식인지 검증
  validate-pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title follows Conventional Commits
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
            tech
          requireScope: false
          subjectPattern: ^(?![A-Z]).+$
          subjectPatternError: |
            PR 제목은 소문자로 시작해야 합니다.

            예시:
            ✅ feat: 새로운 스토리 템플릿 추가
            ✅ fix: 리서치 API 오류 수정
            ❌ feat: Add new template (대문자 시작)

  # PR 본문에 Issue 번호가 포함되어 있는지 검증
  validate-issue-link:
    name: Validate Issue Link
    runs-on: ubuntu-latest
    steps:
      - name: Check if PR links to an issue
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';

            // Issue 연결 패턴: Fixes #123, Closes #123, Resolves #123, Refs #123 등
            const issuePattern = /(fix(es|ed)?|close(s|d)?|resolve(s|d)?|refs?)\s+#\d+/i;

            if (!issuePattern.test(prBody)) {
              core.setFailed(
                '❌ PR 본문에 연결된 Issue가 없습니다.\n\n' +
                'PR 본문에 Issue 번호를 포함해주세요.\n' +
                '예시: Fixes #123, Closes #456, Refs #789\n\n' +
                '모든 PR은 반드시 Issue와 연결되어야 합니다.'
              );
            } else {
              console.log('✅ Issue 연결이 확인되었습니다.');
            }
